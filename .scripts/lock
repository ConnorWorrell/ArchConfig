#!/bin/bash

while test $# -gt 0; do
	case "$1" in
		-h|--help) 
			help="1"
			shift;;
		-b|--buildcache) 
			build="build"
			shift;;
		-r|--rebuildcache) 
			build="rebuild"
			shift;;
		*) 
			echo "unknown flag use --help for more info"
			exit 1;;
	esac
done

if [ "$help" == "1" ]
then
	echo "locks screen, choosing a random background from ~/Wallpapers"
	echo " "
	echo "-b,  --buildcache    build the cache of correctly sized windows, skipping windows that are already cached"
	echo "-r,  --rebuildcache  build the entire cache of correctly sized windows"
	exit 0
fi 

resolution=$(xrandr | fgrep "*" | awk '{print $1}')

if [ "$build" == "build" ] || [ "$build" == "rebuild" ]
then
	
	fileCount=$(ls ~/Wallpapers | wc -l)
	currentfile=1

	echo "building cache"
	for file in ~/Wallpapers/*
	do 
		FileName=$(basename ${file//.jpg/.png})
		CacheFile=~/.Wallpapers_cache/LockScreens/$FileName

		echo $CacheFile $build
		if $(test -f "$CacheFile") && [ "$build" == "build" ]
		then
			echo [$currentfile/$fileCount] $(basename $file) found in cache
			currentfile=$(expr $currentfile + 1)
			continue
		fi

		echo [$currentfile/$fileCount] converting image $file to resolution: $resolution
		

		# echo $FileName
		convert $file -colorspace RGB -gravity center -resize $resolution^ -gravity center -crop $resolution+0+0 +repage PNG:- | convert - ~/.Wallpapers_cache/LockScreens/$FileName

		currentfile=$(expr $currentfile + 1)
	done
	exit 0
fi

file=$(ls ~/Wallpapers | shuf -n 1)
fullpath=~/.Wallpapers_cache/LockScreens/${file//.jpg/.png}

if test -f "$fullpath"; then
	echo "image found in cache"
	i3lock --image $fullpath
	exit 0
fi

echo "image not in cache converting"
convert ~/Wallpapers/$file -colorspace RGB -resize "$resolution^" -gravity center -crop "$resolution" PNG:- | convert - $fullpath

echo "locking"
i3lock --image $fullpath
